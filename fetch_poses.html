<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Poses</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .card-content {
            padding: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            padding-bottom: 50px;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .download-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.2s;
        }

        .download-btn:hover {
            background-color: #059669;
        }

        #page-info {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
        }

        .loading {
            text-align: center;
            font-size: 20px;
            color: #6b7280;
            padding: 50px;
        }

        .error {
            text-align: center;
            color: #ef4444;
            padding: 20px;
            background: #fee2e2;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Poses from Supabase</h1>

        <div class="controls">
            <select id="gender-select" onchange="handleGenderChange()">
                <option value="woman">Woman</option>
                <option value="man">Man</option>
            </select>
        </div>

        <div id="error-container"></div>
        <div id="grid" class="grid"></div>
        <div id="loading" class="loading" style="display: none;">Loading poses...</div>

        <div class="pagination">
            <button id="prev-btn" onclick="changePage(-1)" disabled>Previous</button>
            <span id="page-info">Page 1</span>
            <button id="next-btn" onclick="changePage(1)">Next</button>
        </div>
    </div>

    <script>
        const API_URL = "http://192.168.1.100:3001";
        const LIMIT = 300;
        let currentPage = 1;
        let isLoading = false;
        let currentGender = 'woman';

        // Initial load
        fetchPoses(currentPage);

        function handleGenderChange() {
            const select = document.getElementById('gender-select');
            currentGender = select.value;
            currentPage = 1;
            fetchPoses(currentPage);
        }

        async function fetchPoses(page) {
            if (isLoading) return;

            const grid = document.getElementById('grid');
            const loading = document.getElementById('loading');
            const errorContainer = document.getElementById('error-container');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInfo = document.getElementById('page-info');

            isLoading = true;
            loading.style.display = 'block';
            grid.innerHTML = ''; // Clear current items
            errorContainer.innerHTML = '';

            // Disable buttons during load
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            // Construct URL based on client/components/PoseModal.js logic
            const url = `${API_URL}/api/posesNew?gender=${currentGender}&page=${page}&limit=${LIMIT}`;

            try {
                console.log(`Fetching: ${url}`);
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const responseData = await response.json();
                console.log('Data received:', responseData);

                const data = responseData.data || responseData;
                const poses = data.poses || [];

                if (poses.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No poses found.</p>';
                } else {
                    poses.forEach(pose => {
                        const card = document.createElement('div');
                        card.className = 'card';

                        const title = pose.title || pose.key || `Pose ${pose.id}`;
                        const imageUrl = pose.image || 'https://via.placeholder.com/300x400?text=No+Image';

                        card.innerHTML = `
                            <img src="${imageUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x400?text=Error'">
                            <div class="card-content">
                                <h3 class="card-title" title="${title}">${title}</h3>
                                <button class="download-btn" onclick="downloadImage('${imageUrl}', '${title}')">Download</button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }

                // Update pagination state
                currentPage = page;
                pageInfo.textContent = `Page ${currentPage}`;

                // Enable/Disable buttons
                prevBtn.disabled = currentPage <= 1;

                // Check if there are more pages
                const hasMore = data.hasMore || false;
                nextBtn.disabled = !hasMore;

            } catch (error) {
                console.error('Fetch error:', error);
                errorContainer.innerHTML = `<div class="error">Failed to load poses: ${error.message}</div>`;
                prevBtn.disabled = currentPage <= 1;
            } finally {
                isLoading = false;
                loading.style.display = 'none';
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1) {
                fetchPoses(newPage);
            }
        }

        async function downloadImage(url, title) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (error) {
                console.error('Download failed:', error);
                alert('Failed to download image. Opening in new tab instead.');
                window.open(url, '_blank');
            }
        }
    </script>
</body>

</html>